```{r G1_5_paketit, eval = FALSE, include=FALSE}
# Paketit 1.2.20, kommentoin pois ne joita ei ole käytetty (likert, stargazer)
library(rgl)
library(ca)
library(haven)
library(dplyr)
library(knitr)
library(tidyverse)
library(lubridate)
library(rmarkdown)
library(ggplot2)
library(furniture)
# library(likert) # ei käytetty(1.2.20)
library(scales) # G_1_2 - kuva
library(reshape2)  # G_1_2 - kuva
library(printr) #19.5.18 taulukoiden ja matriisien tulostukseen
# library(stargazer) # 28.5.2018 taulukoiden yms. tulostukseen,ei käytetty(1.2.20)

#Uusia 13.6.2018
library(bookdown)
library(tinytex)
# Uusia 1/2020
library(assertthat)
# library(testthat)
#
#r-skripteillä riittää, kun ajaa tämän
# sessionInfo()
```

# Yksinkertaisen korrespondenssianalyysin laajennuksia 2

Kaksi ensimmäistä lukua ehkä omaksi kokonaisuudeksi, ohitetaan aika kevyesti.


## Matriisien yhdistäminen (stacked and concatenated matices)

Pinotuista tauluista yksinkertainen esimerkki rajatulla aineistolla, selitetään
periaate. Ei laajenneta aineistoa, sillä puuttuvat tiedot aiheuttavat pulmia joihin
sopii parhaiten MCA. MCA on muuttujien välisten suhteiden analyysiä, näin puuttuvista
tiedosta saadan otetta.

Ref:CAip, CA_Week2.pdf (kalvot MCA-kurssilta 2017)


Concatenated tables (yhdistetyt taulut tai matriisit):
(a) kaksi luokittelumuuttujaa (b) useita muuttujia stacked ("pinotaan").

MCA 2017 laskareissa ja kalvoissa esitetään, miten nämä saadaan kätevästi
CA-paketin MJCA-funktion BURT-optiolla.


### Matched matrices

Jos ja kun ei tehdä analyysiä, ei tarvitse omaa jaksoa. Kannattaa mainita, ehkä
vain teoriajaksossa? Idea: matriisien yhdistämisellä saadaan ote monenlaiseen
tutkimusongelmaan. Benzecri: data-analyysissä on vain löydettävä oikea matriisi
joka diagonalisoidaan-


Ref:CAip ss. 177, HY2017_MCA, Greenacre JAS 2013 (sovellus ISSP 1989,4 kysymystä
'pitäisikö äidin olla kotona', 8 maata), tässä artikkelissa "SVD-based methods",
joista yksi CA (muut biplots, PCA, compositional data/log ratios).

Edellisen menetelmän variantti, jossa ryhmien väliset ja sisäiset erot saadaan
esiin. Inertian jakaminen.
Samanlaisten rivien ja sarakkeiden kaksi samankokoista taulua, esimerkiksi
sukupuolivaikutusten arviointi. Alkuperäinen taulukko jaetaan kahdeksi tauluksi
sukupuolen mukaan. Matriisien yhdistäminen (concatenation) riveittäin tai
sarakkeittain ei näytä optimaalisesti mm - matriisien eroja.

Ryhmien välisen ja ryhmien sisäinen inertian erottaminen, **ABBA**
on yksi ratkaisu (ABBA matrix, teknisesti block circular matrix).

Luokittelu voi olla myös kahden indikaattorimuuttujan avulla jako neljään
taulukkoon (esim. miehet vs. naiset länsieuroopassa verratuna samaan asetelmaan
itä-Euroopassa). Samaa ideaa laajennetaan.

Esimerkkinä "Attitudes to women working in 2012".


Substanssimuuttujien (kysymysten) ja taustamuuttujien (demografiset, koulutus,
asuinpaikka) analyysissä ydin on substanssimuuttujien välisissä suhteissa.

Subsanssimuuttujista valitaan seitsemän kysymystä (naisten rooli työmarkkinoilla)
joissa vastausvaihtoehtoja on viisi. Tämä on suositus tai yleinen käytäntö, joka
yksinkertaistaa analyysiä.

Taustamuuttujista valitaan kolme: koulutustaso edu ja asuinpaikka urbru ovat (jos
tiedokeruun erot unohdetaan) taustatietoja.Kolmas muuttujasosta/"Top-Bottom self-placement") 
on kysymys mutta ei pohdita tätä enempää.

Lisämuuttujina ovat sukupuoli (sp), maa ja ikä. Ikä luokitellaan kuuteen ryhmään
ja luodaan ikäluokan ja sukupuolen yhteisvaikutusmuuttuja ga.


```{r G1-5-isodat1}

# str(ISSP2012jh1d.dat) - luotu skripteissä G1_1_data2.Rmd ja G1_1_data_fct1.Rmd

#Valitaan muuttujat joissa puuttuva tieto on koodattu muuttujan arvoksi

MCAvars1 <-  c("Q1am","Q1bm", "Q1cm", "Q1dm","Q1em","Q2am","Q2bm","edum",
                 "sostam", "urbrum", "maa", "ika", "sp" )

MCAdata1jh.dat <- ISSP2012jh1d.dat %>% select(all_of(MCAvars1))
dim(MCAdata1jh.dat)
names(MCAdata1jh.dat)

# luodaan ikaluokka-muuttuja ja ikäluokka-sukupuoli - muuttuja
#age_cat
#ikä 1=15-25, 2 =26-35, 3=36-45, 4=46-55, 5=56-65, 6= 66 and older
MCAdata1jh.dat <- mutate(MCAdata1jh.dat, age_cat = ifelse(ika %in% 15:25, "1",
                                ifelse(ika %in% 26:35, "2",
                                ifelse(ika %in% 36:45, "3",
                                ifelse(ika %in% 46:55, "4",
                                ifelse(ika %in% 56:65, "5", "6"))))))

# str(MCAdata1jh.dat$age_cat)
 # uusi (4.2.20)
MCAdata1jh.dat <- MCAdata1jh.dat %>%        
        mutate(age_cat = as_factor(age_cat))
#tarkastuksia - outo järjestys
# levels(MCAdata1jh.dat$age_cat)
# str(MCAdata1jh.dat$age_cat)
MCAdata1jh.dat<- MCAdata1jh.dat %>%
        mutate(age_cat = fct_relevel(age_cat,
                                   "1",
                                   "2",
                                   "3",
                                   "4",
                                   "5",
                                   "6"))
       
# Tarkistuksia ehkä? (16.10.20)

MCAdata1jh.dat %>%
        tableX(maa,age_cat,type = "count") #%>%
        #kable(digits = 2, caption = "Ikäluokka age_cat")

MCAdata1jh.dat %>%
        tableX(maa,age_cat,type = "row_perc") #%>%
        #kable(digits = 2, caption = "age_cat: suhteelliset frekvenssit")


# Ikäluokka-sukupuoli - muuttuja
MCAdata1jh.dat <- mutate(MCAdata1jh.dat,
                             ga = case_when((age_cat == "1")&(sp == "m") ~ "m1",
                                (age_cat == "2")&(sp == "m") ~ "m2",
                                (age_cat == "3")&(sp == "m") ~ "m3",
                                (age_cat == "4")&(sp == "m") ~ "m4",
                                (age_cat == "5")&(sp == "m") ~ "m5",
                                (age_cat == "6")&(sp == "m") ~ "m6",
                                (age_cat == "1")&(sp == "f") ~ "f1",
                                (age_cat == "2")&(sp == "f") ~ "f2",
                                (age_cat == "3")&(sp == "f") ~ "f3",
                                (age_cat == "4")&(sp == "f") ~ "f4",
                                (age_cat == "4")&(sp == "f") ~ "f4",
                                (age_cat == "5")&(sp == "f") ~ "f5",
                                (age_cat == "6")&(sp == "f") ~ "f6",
                                TRUE ~ "missing"
                                ))


names(MCAdata1jh.dat)
dim(MCAdata1jh.dat)


#Sosiaalinen status: oma arvio "Top-Bottom self-placement"
str(ISSP2012jh1d.dat$sosta)

#Koulutustaso
str(ISSP2012jh1d.dat$edu)

#Asuipaikka
str(ISSP2012jh1d.dat$urbru)

# ikäluokka

# ikäluokka ja sukupuoli - yhteisvaikutusmuuttuja



#Perustietoja

ISSP2012jh1d.dat %>% tableX(maa, sosta)
ISSP2012jh1d.dat %>% tableX(maa, urbru)
ISSP2012jh1d.dat %>% tableX(maa, edu)

ISSP2012jh1d.dat %>% tableX(maa, sosta, type = "row_perc")
ISSP2012jh1d.dat %>% tableX(maa, urbru, type = "row_perc")
ISSP2012jh1d.dat %>% tableX(maa, edu, type = "row_perc")



```

Taustamuuttujien taulukoissa on yllättävän isoja eroja, jotkut taulukoiden luokat
ovat nollia tai hyvin vähän havaintoja. Luokkia pitäisi ehkä yhdistellä,jo pelkästään
"kuvaroskan" takia.

**Puuttuneisuuden yleiskuva**
```{r MCAmissing}
# Puuttuvien tietojen yleiskuva

# Puuttuvat tiedot aineistossa - viite datan dokumentointiin.
# Vaihtelee maittain ja muuttujittain, paljon.

#sum(!complete.cases(ISSP2012jh1d.dat)) = 9455
#dim(ISSP2012jh1d.dat) = 32823
#9455/32823 = 0.2880602
names(MCAdata1jh.dat)
# Puuttuvat tiedot valitussa aineistossa
sum(!complete.cases(MCAdata1jh.dat))
#dim(ISSP2012jh1d.dat) = 32823



```


Yllä havainnot joissa ei ole puuttuvia tietona, havainnoit joissa on ja täydellisten tietojen osuus (71%).

Data on valmiina, edellisen luvun ikäluokka, ikä-sukupuoli- muuttuja ja 
ikä-sukupuoli- maa muuttujien luontia voi harkita.

**edit** Tässä keskityttävä data-analyysin **tutkimusongelmiin**, johdantoa MCA-lukuun.


## MCA
```{r mca1, fig.asp = 1, fig.cap="MCA-kartta: viiden vastausvaihtoehdon kysymykset", out.width = "90%",fig.align = "center"}
# Ensimmäinen MCA - viiden vastausvaihtoehdon kysymykset ja puuttuvat tiedot
mcaDataJH1.dat <- ISSP2012jh1d.dat %>% select(all_of(isodatVars3))

# labelit tiiviimmiksi? Kaksi merkkiä voisi pudottaa Q1am -> 1a
mcaDataJH1.dat <- mcaDataJH1.dat %>% mutate(a1 = Q1am,
                                            b1 = Q1bm, 
                                            c1 = Q1cm,
                                            d1 = Q1dm,
                                            e1 = Q1em,
                                            a2 = Q2am,
                                            b2 = Q2bm)

#Tarkistus

mcaDataJH1.dat %>% tableX (a1, Q1am)
mcaDataJH1.dat %>% tableX (b1, Q1bm)
mcaDataJH1.dat %>% tableX (c1, Q1cm)
mcaDataJH1.dat %>% tableX (d1, Q1dm)
mcaDataJH1.dat %>% tableX (e1, Q1em)
mcaDataJH1.dat %>% tableX (a2, Q2am)
mcaDataJH1.dat %>% tableX (b2, Q2bm)

# glimpse((mcaDataJH1.dat))
mcaDataJH2.dat <- mcaDataJH1.dat %>% select(a1,b1,c1, d1, e1,a2,b2)
 glimpse((mcaDataJH2.dat))

mca1Qmuuttujat <- mjca(mcaDataJH2.dat, ps="")

# ps="" muuttujan ja sen kategorian eroitinmerkki

plot.mjca(mca1Qmuuttujat,
          main = "Viiden vastausvaihtoehdot 7 kysymystä",
          sub = "vastausten koodausta ei käännetty")
plot.mjca(mca1Qmuuttujat, labels = c(2,1),
          main = "Viiden vastausvaihtoehdot 7 kysymystä",
          sub = "vastausten koodausta ei käännetty")
plot.mjca(mca1Qmuuttujat, labels = c(1,2),
          main = "Viiden vastausvaihtoehdot 7 kysymystä",
          sub = "vastausten koodausta ei käännetty")
summary(mca1Qmuuttujat)
# X11()
# subsetcat = (6,12,18,24,30,36,42) - väärä formaatti
# subsetcat=(1:42)[-c(1:5,7:11,13:17,19:23,24:29,31:35, 37:41)]) väärä formaatti

head(mcaDataJH2.dat)
glimpse(mcaDataJH2.dat)
str(mcaDataJH2.dat)
str(mca1Qmuuttujat)
mca1Qmuuttujat$Burt
str(mca1Qmuuttujat$Burt)
mca1Qmuuttujat2 <- mjca(mcaDataJH2.dat, ps="", subsetcat=(1:42)[-c(6,12,18,24,30,36,42)])

plot.mjca(mca1Qmuuttujat2,
          main="Ilman puuttuvia",
          sub = "vastausten koodausta ei käännetty")
summary(mca1Qmuuttujat2)

#mca1Qmuuttujat3 <- mjca(mcaDataJH2.dat, subsetcat=(1:42)[c(6,12,18,24,30,36,4)]) alla toimii, 
# mutta ei hyväksy viimeisiä sarakkeita poistettaviksi (37:41)
mca1Qmuuttujat3 <- mjca(mcaDataJH2.dat, ps="", subsetcat=(1:42)[-c(1:5, 7:11, 13:17, 19:23,25:29,31:35)])

plot.mjca(mca1Qmuuttujat3)
summary(mca1Qmuuttujat3)

#mca1Qmuuttujat3 <- mjca(mcaDataJH2.dat, ps="", subsetcat=(1:42)[-c(1:5, 7:11, 13:17, 19:23,25:29,31:35, 37:41)])



```


