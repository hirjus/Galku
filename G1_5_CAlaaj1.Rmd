```{r G1_5_paketit, eval = FALSE, include=FALSE}
# Paketit 1.2.20, kommentoin pois ne joita ei ole käytetty (likert, stargazer)
library(rgl)
library(ca)
library(haven)
library(dplyr)
library(knitr)
library(tidyverse)
library(lubridate)
library(rmarkdown)
library(ggplot2)
library(furniture)
# library(likert) # ei käytetty(1.2.20)
library(scales) # G_1_2 - kuva
library(reshape2)  # G_1_2 - kuva
library(printr) #19.5.18 taulukoiden ja matriisien tulostukseen
# library(stargazer) # 28.5.2018 taulukoiden yms. tulostukseen,ei käytetty(1.2.20)

#Uusia 13.6.2018
library(bookdown)
library(tinytex)
# Uusia 1/2020
library(assertthat)
# library(testthat)
#
#r-skripteillä riittää, kun ajaa tämän
# sessionInfo()
```

# Yksinkertaisen korrespondenssianalyysin laajennuksia 2

**TODO** Vielä kuuden maan aineistolla ilman puuttuvia havaintoja? Helpompi 
havainnollistaa taulukoiden pinoamista / liittämistä (concate, stack). Ja voisi 
jatkaa ehkä pari pointtia pienellä aineistolla?

```{r G1-5-isodat1}

# str(ISSP2012jh1d.dat)
# Yksinkertaisuuden vuoksi muuttujat tähän

isodatVars1 <- ISSP2012jh1d.dat %>% names()
isodatVars1 <- isodatVars1[24:73]
demogrVars1 <- c("maa","maa3","sp","ika")
isodatVars1 <- isodatVars1[21:50]
isodatVars1 <- c(demogrVars1, isodatVars1)
isodatVars1

ISSP2012jh1d.dat %>% select(all_of(isodatVars1)) %>% 
    summary()

# Muuttujat joissa puuttuvia tietoja (NA), lisäksi maa, maa3, sp ja ika

isodatVars2 <- c("maa","maa3", "sp", "ika","Q1a", "Q1b", "Q1c", "Q1d", "Q1e", "Q2a",
    "Q2b", "Q3a", "Q3b", "edu", "msta", "sosta", "nchild", "lifsta", "urbru")

# muuttujat joissa puuttuvat koodattu arvoksi
isodatVars3 <- c("Q1am","Q1bm", "Q1cm", "Q1dm","Q1em","Q2am","Q2bm" )

testIsodat1.dat <- ISSP2012jh1d.dat %>% select(all_of(isodatVars2))

sum(complete.cases(testIsodat1.dat)) 
sum(!complete.cases(testIsodat1.dat))
# sum(complete.cases(testIsodat1.dat)) + sum(!complete.cases(testIsodat1.dat)) = 32823

# 14789+18034 = 32823 (miehet + naiset)

# Puuttuvat tiedot aineistossa - viite datan dokumentointiin. Vaihtelee maittain ja muuttujittain, paljon.
sum(complete.cases(testIsodat1.dat)) / 32823

# Ei toimi 11.10.20
#
# testIsodat1.dat %>%
#    group_by(maa)
#    summarise(countNA = sum(is.na(all_of(isodatVars3))))

# testIsodat1.dat %>% tableX(maa, isodatVars3)
```
Yllä havainnot joissa ei ole puuttuvia tietona, havainnoit joissa on ja täydellisten tietojen osuus (71%).

Data on valmiina, edellisen luvun ikäluokka, ikä-sukupuoli- muuttuja ja 
ikä-sukupuoli- maa muuttujien luontia voi harkita.

**edit** Tässä keskityttävä data-analyysin **tutkimusongelmiin**, johdantoa MCA-lukuun.

## Matriisien yhdistäminen (stacked and concatenated matices)

Ref:CAip, CA_Week2.pdf (kalvot MCA-kurssilta 2017)


Concatenated tables (yhdistetyt taulut tai matriisit): (a) kaksi luokittelumuuttujaa (b) useita muuttujia stacked ("pinotaan").

MCA 2017 laskareissa ja kalvoissa esitetään, miten nämä saadaan kätevästi CA-paketin MJCA-funktion BURT-optiolla.



## Matched matrices

Ref:CAip ss. 177, HY2017_MCA, Greenacre JAS 2013 (sovellus ISSP 1989, 4 kysymystä 'pitäisikö äidin olla kotona', 8 maata), tässä artikkelissa "SVD-based methods", joista yksi CA (muut biplots, PCA, compositional data/log ratios).

Edellisen menetelmän variantti, jossa ryhmien väliset ja sisäiset erot saadaan esiin. Inertian jakaminen.
Samanlaisten rivien ja sarakkeiden kaksi samankokoista taulua, esimerkiksi sukupuolivaikutusten arviointi. Alkuperäinen taulukko jaetaan kahdeksi tauluksi sukupuolen mukaan. Matriisien yhdistäminen (concatenation) riveittäin tai sarakkeittain ei näytä optimaalisesti mm - matriisien eroja.

Ryhmien välisen ja ryhmien sisäinen inertian erottaminen, **ABBA** on yksi ratkaisu (ABBA matrix, teknisesti block circulanMat matrix).

Luokittelu voi olla myös kahden indikaattorimuuttujan avulla jako neljään taulukkoon (esim. miehet vs. naiset länsieuroopassa verratuna samaan asetelmaan itä-Euroopassa). Samaa ideaa laajennetaan.

Esimerkkinä "Attitudes to women working in 2012".

## MCA
```{r mca1, fig.asp = 1, fig.cap="MCA-kartta: viiden vastausvaihtoehdon kysymykset", out.width = "90%",fig.align = "center"}
# Ensimmäinen MCA - viiden vastausvaihtoehdon kysymykset ja puuttuvat tiedot
mcaDataJH1.dat <- ISSP2012jh1d.dat %>% select(all_of(isodatVars3))

# labelit tiiviimmiksi? Kaksi merkkiä voisi pudottaa Q1am -> 1a
mcaDataJH1.dat <- mcaDataJH1.dat %>% mutate(a1 = Q1am,
                                            b1 = Q1bm, 
                                            c1 = Q1cm,
                                            d1 = Q1dm,
                                            e1 = Q1em,
                                            a2 = Q2am,
                                            b2 = Q2bm)

#Tarkistus

mcaDataJH1.dat %>% tableX (a1, Q1am)
mcaDataJH1.dat %>% tableX (b1, Q1bm)
mcaDataJH1.dat %>% tableX (c1, Q1cm)
mcaDataJH1.dat %>% tableX (d1, Q1dm)
mcaDataJH1.dat %>% tableX (e1, Q1em)
mcaDataJH1.dat %>% tableX (a2, Q2am)
mcaDataJH1.dat %>% tableX (b2, Q2bm)

# glimpse((mcaDataJH1.dat))
mcaDataJH2.dat <- mcaDataJH1.dat %>% select(a1,b1,c1, d1, e1,a2,b2)
 glimpse((mcaDataJH2.dat))

mca1Qmuuttujat <- mjca(mcaDataJH2.dat, ps="")

# ps="" muuttujan ja sen kategorian eroitinmerkki

plot.mjca(mca1Qmuuttujat,
          main = "Viiden vastausvaihtoehdot 7 kysymystä",
          sub = "vastausten koodausta ei käännetty")
plot.mjca(mca1Qmuuttujat, labels = c(2,1),
          main = "Viiden vastausvaihtoehdot 7 kysymystä",
          sub = "vastausten koodausta ei käännetty")
plot.mjca(mca1Qmuuttujat, labels = c(1,2),
          main = "Viiden vastausvaihtoehdot 7 kysymystä",
          sub = "vastausten koodausta ei käännetty")
summary(mca1Qmuuttujat)
# X11()
# subsetcat = (6,12,18,24,30,36,42) - väärä formaatti
# subsetcat=(1:42)[-c(1:5,7:11,13:17,19:23,24:29,31:35, 37:41)]) väärä formaatti

head(mcaDataJH2.dat)
glimpse(mcaDataJH2.dat)
str(mcaDataJH2.dat)
str(mca1Qmuuttujat)
mca1Qmuuttujat$Burt
str(mca1Qmuuttujat$Burt)
mca1Qmuuttujat2 <- mjca(mcaDataJH2.dat, ps="", subsetcat=(1:42)[-c(6,12,18,24,30,36,42)])

plot.mjca(mca1Qmuuttujat2,
          main="Ilman puuttuvia",
          sub = "vastausten koodausta ei käännetty")
summary(mca1Qmuuttujat2)

#mca1Qmuuttujat3 <- mjca(mcaDataJH2.dat, subsetcat=(1:42)[c(6,12,18,24,30,36,4)]) alla toimii, 
# mutta ei hyväksy viimeisiä sarakkeita poistettaviksi (37:41)
mca1Qmuuttujat3 <- mjca(mcaDataJH2.dat, ps="", subsetcat=(1:42)[-c(1:5, 7:11, 13:17, 19:23,25:29,31:35)])

plot.mjca(mca1Qmuuttujat3)
summary(mca1Qmuuttujat3)

#mca1Qmuuttujat3 <- mjca(mcaDataJH2.dat, ps="", subsetcat=(1:42)[-c(1:5, 7:11, 13:17, 19:23,25:29,31:35, 37:41)])



```


