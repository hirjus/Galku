# Yksinkertainen korrespondenssianalyysi - kahden luokittelumuuttujan taulukko

```{r paketit_g12, include=FALSE}
# Paketit 1.2.20, kommentoin pois ne joita ei ole käytetty (likert, stargazer)
# paketit.R - kopioidaan Rmd-tiedostojen alkuun

library(rgl)
library(ca)
library(haven)
library(dplyr)
library(knitr)
library(tidyverse)
library(lubridate)
library(rmarkdown)
library(ggplot2)
library(furniture)
# library(likert) # ei käytetty(1.2.20)
library(scales) # G_1_2 - kuva
library(reshape2)  # G_1_2 - kuva
library(printr) #19.5.18 taulukoiden ja matriisien tulostukseen
# library(stargazer) # 28.5.2018 taulukoiden yms. tulostukseen,ei käytetty(1.2.20)

#Uusia 13.6.2018
library(bookdown)
library(tinytex)
# Uusia 1/2020
library(assertthat)
library(testthat)

# sessionInfo()

```

**Vanhaa jäsennystä**  

Yksinkertainen esimerkki, yksi kysymys (V6/Q1b) ja kuusi maata ristiintaulukoituna. Johdatteluna aiheeseen esitellään ca-käsitteet profiili, massa ja reunajakauma. Havainnollistetaan rivi- ja sarakeprofiilien vertailua vastaaviin keskiarvoprofiileihin.

Taulukoita tarkastella ensin rivien ja sitten sarakkeiden suhteen. Miten ne poikkeavat keskiarvostaan, miten toisistaan saman kategorian profiilista. Usein taulukoissa muuttujilla on selvästi eri rooli, kuten tässä. Koitan hahmottaa maiden (=aggregoituja yksilöitä) eroja ja yhtäläisyyksiä. Sarakkeiden vertailussa taas näemme, miten muuttujien profiilit poikkeavat keskiarvostaan. Monia riippuvuksia ja poikkeamia näyttäisi olevan. Klassinen ongelma, Pearson ja Fisher (ehkä turhaa tässä?).


Riippumattomuushypoteesi ja $\chi^2$ - riippumattomuustesti (pieni huomautus - on monta tapaa testata taulukon riippuvuuksia). Riippumattomuushypoteesi ehdollisena todennäköisyytenä reunajakauman suhteen. 
**zxy** Tämä puuttuu kaavoista!

**zxy**

**Tarvitaanko käsitteellistä täsmentämistä, tai selkiinnyttämistä?**

1. Taulukon käsite

Erityisesti CA, jossa "ranskalaisella terminologialla" käsitellään yksilöiden tai havaintoyksiköiden pilveä ja muuttujien pilvelä (nominaaliasteikko). Taulukot saadaan yksinkertaisen CA:n tapauksessa aggregoimalla "cloud of individuals". 
**#V** MOOC, LeReoux

2. Kontingenssitaulu (kts. viite, jossa ohje "yhteys aina riviä pitkin"), frekvenssitaulu, ristiintaulukointi
- dataa valitaan, aggregoidaan, ryhmitellään. Aktiivisia valintoja. Blasius emt. "data ei löydy kadulta", ja vaikka siitä ei ole epäilystäkään ISSP-datan tapauksessa, niin siitäkin jatketaan eteenpäin.

3. Peruskäsitteiden yksinkertaisessa esityksessä tärkein lähde MG:n CAiP **#V** Siellä tästäkin on sananen: substanssiero usein on.

3. CA:ssa hämäävä juttu (Blasius, "vizualisation - verkkokirja") rivien ja sarakkeiden **tekninen**
symmetria. 


$\chi^2$ - etäisyys, yhteys hajontaan eli inertiaan ca-terminologiassa.

Dimensioiden vähentämisen idea ("the essence"), joka ei pienessä taulossa ole ihan ilmeinen. Toinen tavoite on visualisointi, yleensä kaksiulotteisena kuvana (karttana).

Yksinkertainen korrespondenssianalyysi on kahden luokitteluasteikon muuttujan riippuvuuksien geometrista analyysiä. Lähtökohta on kahden muuttujan ristiintaulukointi, alkuperäinen data voi olla muillakin asteikoilla mitattua. Menetelmän ydin on tarkastella molempien muuttujien -- taulukon rivien ja sarakkeiden -- riippuvuuksia kaksiulotteisena kuvana. Kuvaa kutsutaan myös kartaksi, ja tulkinnan ensimmäinen askel on kartan "koordinaatiston" tulkinta. Kaikki etäisyydet kuvassa ovat suhteellisia, vain rivi- ja sarakepisteiden etäisyydet kuvan origosta voidaan tulkita tarkasti. Koordinaatiston tulkinta aloitetaan "katsomalla mitä on oikealla ja vasemmalla, ja mitä on ylhäällä ja alhaalla" (viite LeRoux et.al, Bezecri-sitaatti). Vaikka pisteiden etäisyyksiä edes rivi- ja sarakepisteiden välillä ei voi tarkkaan tulkita (approksimaatioita), projektiossa kaukana toisistaan olevat pisteet ovat kaukana toisistaan myös alkuperäisessä "pistepilvessä".

Akseleiden tulkinta "ääripäiden" kautta ("kontrasti" ?). Huom "ääripää" ei välttämättä Likert-asteikolla tarkoita "äärimielipidettä", vaan se voi tarkoittaa myös selvää tai varmaa mielipidettä.(3.10.18).

**Vanha lista:**

1. Ensimmäinen taulukko: profiilit, massat, keskiarvoprofiilit, khii2 - riippumattomuustesti ja etäisyysmitta

2. Hyvin tiivis esitys CA:n perusideasta, mutta ilman aivan simppeleitä kolmiulotteisia kuvia (niitä on jo)

3. Ensimmäinen symmetrinen kartta, perustulkinta (mitä kuvasta voidaan sanoa, mitä ei)

4.  Lyhyt viittaus graafisen esityksen tulkintapulmiin, jotka eivät ole kovin pahoja. CA-kartta kaksoiskuvana (ts. informaatio voidaan palauttaa, skalaaritulo)? 

5. Tulkinnan syventäminen - CA-käsitteiden tarkempi esittely

Haaste: käsitteet ja niiden suhteet ovat abstraktien matemaattisten rakenteiden tuloksia (barycentric, sentroidi), ja ne pitää jotenkin johdonmukaisesti pala kerrallaan tuoda esimerkkien kautta tekstiin. Käsittteistä oma Rmd (ja Excel jos osoittautuu kätevämmäksi), kaavaliite Dispo-repossa ja myös Rmd-muodossa. **edit** Kaavaliitteessä pieniä eroja, ja tekstiä on LateX-versiossa enemmän.

**Ensimmäinen symmetrinen kartta**

Tulkinnat ja yksinkertaisimmat perussäännöt. Dimensiot ja kuinka paljon alkuperäisen taulukon inertiaa saadaan esitettyä kartalla. Sitten asian ydin, akseleiden tulkinta ("mitä on oikealla ja vasemmalla"). Jos pisteet ovat alkuperäisessä "pilvessä" kaukana toisistaan, ne ovat sitä myös projektiossa. Kartta, mutta etäisyyksillä ei suoraa tulkintaa paitsi eteisyyksinllä origoon. Rivipisteiden suhteelliset etäisyydet, samoin sarakepisteidet. Mitä tarkoittavat prosentit akseleilla?

Varoitus virhetulkinnasta: ryhmien tunnistaminen rivi, jopa rivi- ja sarakepisteistä koostuvien ryhmien. 
**zxy** Ja silti tavallaan voi. Sarake- ja rivipisteiden etäisyyksille ei ole suoraa tulkintaa, mutta on "vetovoima" (attraktio) ja "työntövoima" (repulsio). Jos profiilissa sarakemuuttujan osuus on suuri (siis suurempi kuin keskiarvopisteessä, suhteellinen ero), se "ajautuu" lähelle sarekepistettä. MG: "loose ends" - paperi, symmetrinen kuva eräs suurin sekaannuksen lähde. Tätä koitetaan selventää myös MG:n JASA-artikkelissa.

**zxy** termi korrespondenssi: "neglected multivariate method" - paperissa käännetty näin englanniksi ransk. termi (Benzecri) rivien ja sarakkeiden "correspondence" eli yhteys/"riippuvuus"/vastaavuus tms.

**zxy** . Tarina: valitaan edellisessä luvussa esitetyn pohjalta osa muuttujista, perustellaan miksi työmarkkia-asenteen ovat kiinnostavia, valitaan esimerkkianalyyseihin **yksi** muuttuja ja kuusi maata.

## Äiti työssä

**zxy** Perustellaan aineiston valinnan vaiheet. Esimerkiksi otetaan yksi kysymys.

**zxy** Suhde data-lukuun, siellä pitäisi esitellä aineisto sisällöllisesti. Tässä vain valitan esimerkkiä varten yksi kysymys ja kuusi maata.

**zxy** Muuttujien nimeäminen vaikuttaa (a) muuttujien faktorointiin ja (b) kuviin ja taulukoihin.


Aineisto muuttujat V5-V9 ovat vastauksia ensimmäiseen kysymyspatteriin (Q1a-Q1e, arvot 1-5, täysin samaa mieltä - täysin eri mieltä). 


(V6/Q1b) Alle kouluikäinen lapsi todennäköisesti kärsii, jos hänen äitinsä käy työssä. V6 muunnetaan uudeksi luokittelumuuttujaksi (R:ssä factor) Q1b. Tämä ei vielä tee kuvista ahtaita kun sarakkeita ja rivejä on vähän. Pudotetaan tarvittaessa turha Q-kirjain pois. Alkuperäisessä muuttujassa metatieto säilyy varmemmin, ja tarkistuksia on helpompi tehdä.

```{r esim1data1OLD, eval=FALSE, include=FALSE}
#
# LUETAAN DATA G1_1_data2.Rmd - tiedostossa  -> ISSP2012jh1d.data
# 23 muuttujaa (9 substanssimuuttujaa, 8 taustamuuttujaa, 3 maa-muuttujaa, 3 metadatamuuttujaa)
# 25 maata
# Poistettu 146 havaintoa, joilla SEX tai AGE puuttuu
#

# Yksi kysymys ja kuusi maata
# incl_esim1 <- c(56, 100, 208, 246, 276, 348) #BE,BG,DK,FI,DE,HU)

# ISSP2012esim1.dat <- filter(ISSP2012.data, V4 %in% incl_esim1) 
# str(ISSP2012esim1.dat) #8557 obs. of  420 variables
#
# mukaan muuttujat, V3 jos halutaan jakaa Saksa ja Belgia
# SEX 1=male, 2=female AGE haastateltava ikä haastatteluhetkellä
#
#  C_ALPHAN, V3,V4, V6, SEX, AGE) 

# str(ISSP2012esim1.dat) #8557 obs. of  6 variables
#

```

Valitaan esimerkin data edellisessä luvussa luodusta R-datasta ISSP2012jh1c.data (df). Ihan yhtä hyvin voisi aina lukea suoraan alkuperäisestä spss-tiedostosta, mutta pidemmässä raportissa tämä on siistimpi tapa (23.3.2019).

```{r esim1data1}
# UUSI DATA 30.1.20
#
# LUETAAN DATA G1_1_data2.Rmd - tiedostossa, luodaan faktorimuuttujat 
# G1_1_data_fct1.Rmd-tiedostossa -> ISSP2012jh1d.dat (df) 
# 23 muuttujaa (9 substanssimuuttujaa, 8 taustamuuttujaa, 3 maa-muuttujaa, 3 metadatamuuttujaa)
# 25 maata.
# Poistettu 146 havaintoa, joilla SEX tai AGE puuttuu
# Johdattelevassa esimerkissä kuusi maata, kaksi taustamuuttujaa ja yksi kysymys (V6/Q1b) 

# Kuusi maata

countries_esim1 <- c(56, 100, 208, 246, 276, 348) #BE,BG,DK,FI,DE,HU
ISSP2012esim3.dat <- filter(ISSP2012jh1d.dat, V4 %in% countries_esim1)
str(ISSP2012esim3.dat)

#neljä maamuuttujaa, kysymys Q1b, ikä ja sukupuoli

vars_esim1 <- c("C_ALPHAN", "V3", "maa","maa3", "Q1b", "sp", "ika") 
ISSP2012esim2.dat <- select(ISSP2012esim3.dat, all_of(vars_esim1))

str(ISSP2012esim2.dat) # 8542 obs. of  7 variables
# C_ALPHAN: chr, maa: Factor w/ 25 

# Poistetaan havainnot, joilla Q1b - muuttujassa puuttuva tieto 'NA'

ISSP2012esim1.dat <- filter(ISSP2012esim2.dat, !is.na(Q1b))

str(ISSP2012esim1.dat) # 8143 obs. of  6 variable

# Tarkistuksia - miksi nämä eivät tulosta mitään? (3.2.20)

fct_count(ISSP2012esim1.dat$sp) %>% table1()
fct_count(ISSP2012esim1.dat$Q1b)
fct_count(ISSP2012esim1.dat$maa)
fct_count(ISSP2012esim1.dat$maa3)

# Toimivat tarkistukset (3.2.20)
summary(ISSP2012esim1.dat$sp)
#sp: 3799 + 4344 = 8143
summary(ISSP2012esim1.dat$Q1b)
#  S      s      ?     e      E 
# 810 + 1935 + 1367 + 2125 + 1906 = 8143


# EDELLINEN DATA - havaintojen määrät samat kuin uudella datalla (31.1.20)
#
# 8557 obs. ennen kuin sexagemissing poistettiin, nyt 8542, 8557-8542 = 15
#
# Poistetaan havainnot joissa puuttuva tieto muuttujassa V6 (Q1b) n = 399
# 8542-399 = 8143

# Tyhjät "faktorilabelit" on poistettava

 ISSP2012esim1.dat <- ISSP2012esim1.dat %>% 
     mutate(maa = fct_drop(maa),
            maa3 = fct_drop(maa3)
            )

summary(ISSP2012esim1.dat$maa)
summary(ISSP2012esim1.dat$maa3)

# str(ISSP2012esim1.dat$maa)
# attributes(ISSP2012esim1.dat$maa)

# str(ISSP2012esim1.dat$maa3)
# attributes(ISSP2012esim1.dat$maa3)


ISSP2012esim1.dat %>% tableX(maa, Q1b, type = "count")
fct_count(ISSP2012esim1.dat$Q1b)

# fct_count(ISSP2012esim1.dat$sp)
# fct_unique(ISSP2012esim1.dat$maa)
# fct_count(ISSP2012esim1.dat$maa)
ISSP2012esim1.dat %>% tableX(maa, C_ALPHAN, type = "count")


# maa3 - siistitään "faktorilabelit" kaksikirjaimisiksi
#
# ISO 3166 Code V3 - maiden jaot
#  5601     BE-FLA-Belgium/ Flanders
#  5602     BE-WAL-Belgium/ Wallonia
#  5603     BE-BRU-Belgium/ Brussels
# 27601     DE-W-Germany-West
# 27602     DE-E-Germany-East
# Tähän pitäisi päästä
# levels = c("100","208","246","348","5601","5602","5603","27601","27602"),
#  labels = c("BG","DK","FI","HU","bF","bW","bB","dW","dE"))
levels(ISSP2012esim1.dat$maa3)
ISSP2012esim1.dat <- ISSP2012esim1.dat %>%
        mutate(maa3 =
                fct_recode(maa3,
                 "BG" = "BG-Bulgaria",
                 "DK" = "DK-Denmark",
                 "FI" = "FI-Finland",
                 "HU" = "HU-Hungary",
                 "bF" = "BE-FLA-Belgium/ Flanders",
                 "bW" = "BE-WAL-Belgium/ Wallonia",
                 "bB" = "BE-BRU-Belgium/ Brussels",
                 "dW" = "DE-W-Germany-West",
                 "dE" = "DE-E-Germany-East")
               )
# tarkistuksia
levels(ISSP2012esim1.dat$maa3)
# str(ISSP2012esim1.dat$maa3) # 9 levels
summary(ISSP2012esim1.dat$maa3)



# TÄSSÄ TOISTOA! (4.2.20)

# Muutetaan muuttujan "maa" arvojen (levels) järjestys samaksi kuin alkuperäisen
# muuttujan C_ALPHAN. Helpomi verrata aikaisempiin tuloksiin.

# maa samaan järjestukseen kuin C_ALPHAN - olisiko aakkosjärjestys?
# tämä vain siksi, että muuten  esimerkin ca-kartta "kääntyy"
# "vanha" maa-muuttuja talteen - ei ehkä tarpeen? (4.2.20)

ISSP2012esim1.dat$maa2 <- ISSP2012esim1.dat$maa # "alkuperäinen" maa talteen

ISSP2012esim1.dat <- ISSP2012esim1.dat %>%
        mutate(maa =
                fct_relevel(maa,
                            "BE",
                            "BG",
                            "DE",
                            "DK",
                            "FI",
                            "HU"))

# Tarkistus
ISSP2012esim1.dat %>% tableX(maa2,maa, type = "count") 
ISSP2012esim1.dat %>% tableX(maa,C_ALPHAN, type = "count")
str(ISSP2012esim1.dat)

```



**TODO** Taulukot erotettava omiksi koodilohkoiksi bookdowniin.


```{r esim1data2}
# Taulukoita (31.1.2020)

# toinen maa-muuttuja, jossa Saksan ja Belgian jako
#  V3
#  5601     BE-FLA-Belgium/ Flanders
#  5602     BE-WAL-Belgium/ Wallonia
#  5603     BE-BRU-Belgium/ Brussels
# 27601     DE-W-Germany-West
# 27602     DE-E-Germany-East
#
# Tarkastuksia
#
ISSP2012esim1.dat %>% tableX(maa,Q1b,type = "count")
ISSP2012esim1.dat %>% tableX(maa,ika,type = "count")
# ISSP2012esim1.dat %>% tableX(maa,sp ,type= "count")

# Riviprofiilit

# ISSP2012esim1.dat %>% tableX(maa,ika,type = "row_perc")
ISSP2012esim1.dat %>% tableX(maa,sp ,type= "row_perc")

# Kysymyksen Q1b vastaukset

ISSP2012esim1.dat %>% tableX(maa,Q1b,type = "row_perc")

# Kuuluu ehkä vasta seuraavaan jaksoon ? (20.2.20)

ISSP2012esim1.dat %>% tableX(maa3,Q1b,type = "row_perc")

# str(ISSP2012esim1.dat) # 8143 obs. of  7 variable, 
# sama kuin vanhassa Galku-koodissa. 

```

**Taulukot ja kuvat omina koodilohkoina**


**Frekvenssitaulukko**

```{r simpeCAfrekTa1}

# Esimerkki - siisti tuloste (20.2.20)

taulu2 <- ISSP2012esim1.dat %>% tableX(maa, Q1b, type = "count")
knitr::kable(taulu2,digits = 2, booktabs = TRUE, 
             caption = "Kysymyksen Q1b vastaukset maittain")
```

**Riviprosentit**

```{r simpeCArprosTa1}
taulu3 <- ISSP2012esim1.dat %>% tableX(maa,Q1b,type = "row_perc")

knitr::kable(taulu3,digits = 2, booktabs = TRUE, 
             caption = "Kysymyksen Q1b vastaukset, riviprosentit")
```

**Sarakeprosentit**

```{r simpeCAcprosTa1}
taulu4 <- ISSP2012esim1.dat %>% tableX(maa,Q1b,type = "col_perc")

knitr::kable(taulu4,digits = 2, booktabs = TRUE,
             caption = "Kysymyksen Q1b vastaukset, sarakeprosentit")
```


Taulukoissa on kuuden maan vastausten jakauma kysymykseen "Alle kouluikäinen lapsi todennäköisesti kärsii, jos hänen äitinsä käy työssä". Taulukko on pieni, mutta havaintoja 8143. Alemman suhteellisten frekvenssien taulukon rivejä voi verrata toisiinsa ja alimpaan ("Total"") keskimääräiseen riviin, sarakemuuttujien eli vastausvaihtoehtojen reunajakaumaan. Vastavasti sarakkeita voi verrata rivimuuttujien reunajakaumasarakkeeseen ("Total2). Eniten vastaajia on Belgiasta (25 %) ja Saksasta (21 %), vähiten Unkarista (12 %).

**EDIT:** Pienenkin taulukon pyörittely johdattelee hyvin, mihin korrespondenssianalyysiä tarvitaan. Näistähän riippuvuuden rakenteet näkee ilmankin, jos on tarpeeksi nokkela. 
Isommissa aineistoissa (enemmän muuttujia) ei onnistu.

```{r EkaCA}
# CA tässä, jotta saadaan rivi- ja sarakeprofiilikuvat

simpleCA1 <- ca(~maa + Q1b,ISSP2012esim1.dat)

# Maiden järjestys kääntää kuvan (1.2.20) - esimerkki on 
# vähän kuriositeetti. Kartta voi tietysti "flipata" koordintaattien suhteen ainakin
# neljällä tavalla (? 180 astetta molempien akseleiden ympäri molempiin suuntiin?)
# (18.2.20).

simpleCA2 <- ca(~maa2 + Q1b,ISSP2012esim1.dat)

# Oikeastaan maiden vertailussa pitäisi niiden massat skaalata yhtä suuriksi, tässä
# pikainen kokeilu (20.2.20)
# Riviprosentit taulukoksi, nimet sarakkeille ja riveille (ei kovin robustia...)


johdesim1_rowproc.tab <- simpleCA1$N / rowSums(simpleCA1$N)

# TARKISTUKSIA (20.2.20)
# print(johdesim1_rowproc.tab)
# rowSums(johdesim1_rowproc.tab)
# str(johdesim1_rowproc.tab)

colnames(johdesim1_rowproc.tab)<-c("S" ,"s" ,"?","e", "E")
row.names(johdesim1_rowproc.tab) <- c("BE", "BG", "DE", "DK", "FI", "HU")


simpleCA3 <- ca(johdesim1_rowproc.tab)

# Kartta piirretään koodilohkossa simpleCAmap1

# Riviprosentit tarkistusta varten
#        S	s	?	e	E
#BE	9.49	22.40	21.76	27.42	18.93
#BG	12.81	42.89	22.26	20.63	1.41
#DE	9.63	21.88	11.55	31.39	25.55
#DK	5.04	17.15	10.95	16.71	50.14
#FI	4.23	16.94	13.42	38.11	27.30
#HU	21.97	28.89	22.57	19.06	7.52
# 
# Ja datan saa leikepöydän kautta, jos on tarve pikatarkistuksiin
# read <- read.table("clipboard")

```


Symmetrinen kartta, jossa maiden painot vakioitu. CA-funktiolle lähtötiedoksi 
riviprofiilit. **TODO 20.2.20** Siirrä seuraavaan lukuun!

**TODO 2.2.20** 

Onko tämä kuva tallennettava kuvatiedostoksi, vai onnistuuko sen tuottaminen 
Bookdownissa. Ei taida onnistua? (4.9.18)

Sarakeprofiilit, oikea järjestys maa-muuttujan tasoilla.

```{r g1_2_kuva1}

#mutkikas kuvan piirto - sarakeprofiilit vertailussa
#ggplot vaatii df-rakenteen ja 'long data' - muotoon
##https://stackoverflow.com/questions/9563368/create-stacked-barplot-where-each-stack-is-scaled-to-sum-to
#
# käytetään ca - tuloksia
apu1 <- (simpleCA1$N)
colnames(apu1) <- c("S", "s", "?", "e", "E")
rownames(apu1) <- c("BE", "BG", "DE", "DK", "FI", "HU")
apu1_df <- as.data.frame(apu1)
#lasketan rivien reunajakauma
apu1_df$ka_sarake <- rowSums(apu1_df)
#muokataan 'long data' - muotoon
apu1b_df <- melt(cbind(apu1_df, ind = rownames(apu1_df)), id.vars = c('ind'))

ggplot(apu1b_df, aes(x = variable, y = value, fill = ind)) +
         geom_bar(position = "fill", stat ="identity") +
         scale_y_continuous(labels = percent_format()) 
#apu1b_df
```

Testaus: maa2, eri järjestys kuin C_ALPHAN (joka oli käytössä vanhemmissa Galku-versioissa)

```{r g1_2_kuva1test}

#mutkikas kuvan piirto - sarakeprofiilit vertailussa
#ggplot vaatii df-rakenteen ja 'long data' - muotoon
##https://stackoverflow.com/questions/9563368/create-stacked-barplot-where-each-stack-is-scaled-to-sum-to
#
# käytetään ca - tuloksia
apu1test <- (simpleCA2$N)
colnames(apu1test) <- c("S", "s", "?", "e", "E")
rownames(apu1test) <- c("BE", "BG", "DE", "DK", "FI", "HU")
apu1_dftest <- as.data.frame(apu1test)
#lasketan rivien reunajakauma
apu1_dftest$ka_sarake <- rowSums(apu1_dftest)
#muokataan 'long data' - muotoon
apu1b_dftest <- melt(cbind(apu1_dftest, ind = rownames(apu1_dftest)), id.vars = c('ind'))

ggplot(apu1b_dftest, aes(x = variable, y = value, fill = ind)) +
         geom_bar(position = "fill", stat ="identity") +
         scale_y_continuous(labels = percent_format()) 

```

**TODO 2.2.20 ** Massat saa mukaan vaikka viittaamalla frekvenssitauluun (4.9.2018)

Riviprofiilikuva toimii, mutta vaatii vielä viilausta (18.9.2018).


```{r g1_2_kuva2, echo=TRUE}
# riviprofiilit ja keskiarvorivi -  18.9.2018
apu2_df <- as.data.frame(apu1)
apu2_df <- rbind(apu2_df, ka_rivi = colSums(apu2_df))

#apu2_df
#str(apu2_df)
## typeof(apu2_df) # what is it?
## class(apu2_df) # what is it? (sorry)
## storage.mode(apu2_df) # what is it? (very sorry)
## length(apu2_df) # how long is it? What about two dimensional 
## objects?
# attributes(apu2_df) 

# temp1 <- cbind(apu2_df, ind = rownames(apu2_df))
# temp1
##muokataan 'long data' - muotoon
apu2b_df <- melt(cbind(apu2_df, ind = rownames(apu2_df)), id.vars = c('ind'))
#apu2b_df
#
#
#ggplot(apu2b_df, aes(x = value, y = ind, fill = variable)) +
#       geom_bar(position = "fill", stat ="identity") +
#       #coord_flip() +
#        scale_x_continuous(labels = percent_format()) 
#versio2 # perkele, tämä toimii! 18.9.2018
ggplot(apu2b_df, aes(x = ind, y = value, fill = variable)) +
       geom_bar(position = "fill", stat ="identity") +
       coord_flip() +
        scale_y_continuous(labels = percent_format()) 
```

Ja sama testaus kuin sarakeprofiilikuvilla

```{r g1_2_kuva2test, echo=TRUE}
# riviprofiilit ja keskiarvorivi -  18.9.2018
apu2_dftest <- as.data.frame(apu1test)
apu2_dftest <- rbind(apu2_dftest, ka_rivi = colSums(apu2_dftest))

#apu2_df
#str(apu2_df)
## typeof(apu2_df) # what is it?
## class(apu2_df) # what is it? (sorry)
## storage.mode(apu2_df) # what is it? (very sorry)
## length(apu2_df) # how long is it? What about two dimensional 
## objects?
# attributes(apu2_df) 

# temp1 <- cbind(apu2_df, ind = rownames(apu2_df))
# temp1
##muokataan 'long data' - muotoon
apu2b_dftest <- melt(cbind(apu2_dftest, ind = rownames(apu2_dftest)), id.vars = c('ind'))
#apu2b_df
#
#
#ggplot(apu2b_df, aes(x = value, y = ind, fill = variable)) +
#       geom_bar(position = "fill", stat ="identity") +
#       #coord_flip() +
#        scale_x_continuous(labels = percent_format()) 
#versio2 # toimii 18.9.2018
ggplot(apu2b_dftest, aes(x = ind, y = value, fill = variable)) +
       geom_bar(position = "fill", stat ="identity") +
       coord_flip() +
        scale_y_continuous(labels = percent_format()) 
```

**Graafinen analyysi ja R**

Käytänön neuvoja data-analyysiin, kuulunee tekstiin, vai meneekö "ohjelmistoympäristö" -liitteeseen? Tärkeä juttu!

Kuvasuhteen saa oikeaksi, kun avaa g-ikkunan (X11()) ja sitten plot. Voi tallentaa pdf-muodossa
grafiikkaikkunasta, ja ladata outputiin knitr-vaiheessa. Parempi tulostaa kuvatdsto pdf-ajurilla, jos lopulliseen versioon joutuu näin tekemään (13.5.2018 ). Tämä voi olla järkevä tapa analyysivaiheessa? Teksti kopsattu alla olevasta koodilohkosta.

Ensimmäinen korrespondenssianalyysi - kokeiluja kuvasuhteen säätämiseksi output-dokumentissa. RStudiossa voi avata komentokehoitteessa grafiikka-ikkunan. Siitä käsin tallennettu pdf-kuva on ladattu alla Rmarkdownin omalla komennolla, kohdistus keskelle. Parhaiten näyttäisi toimivan knitrin funktio, mutta oletuskuvakoolla saa ca-kuvasta näköjään aika lähelle oikeanlaisen ilman mitään temppuja.

**zxy** Selventäisikö vielä khii2-etäisyyksien taulukko, tai ehkä seuraavassa luvussa? **#V** MG&Blasius, "vihreän kirja", johdanto.

**Rivien (1) ja sarakkeiden (2) khii2-etäisyydet keskiarvosta.**
**TODO 19.2.20** Siiti taulukko.

```{r khii2dist1}
# khii2 - etäisyyksien taulukko
#str(simpleCA1)
#simpleCA1$rowdist
#str(simpleCA1$rowdist)
#tablRowDist <- simpleCA1$rowdist
#rownames(tablRowDist) <- simpleCA1$rownames
simpleCA1$rowdist
simpleCA1$coldist

```

```{r khii2dist2}
# Onko maiden järjestyksellä vaikutusta khii2-etäisyyksiin? Ei ole, 
# tietenkään, mutta rivit eri järjestyksessä (2.2.20).
simpleCA1$rowdist
simpleCA2$rowdist
# [1] 0.1579735 0.6309909 0.1750128 0.6340627 0.3477331 0.5504040
# [1] 0.6309909 0.6340627 0.3477331 0.5504040 0.1579735 0.1750128
simpleCA1$coldist
simpleCA2$coldist
# sarekeilla khii2-etäisyydet samat ja samassa järjestyksessä
# [1] 0.5246525 0.3248840 0.3078230 0.2721699 0.6271108
# [1] 0.5246525 0.3248840 0.3078230 0.2721699 0.6271108

```


CA-ratkaisun lähtötieto: suhteelliset frekvenssit (korrespondenssimatriisi P)

```{r simpleCArelfrekTa1}
taulu5 <-ISSP2012esim1.dat %>% tableX(maa,Q1b,type = "cell_perc")
knitr::kable(taulu5,digits = 2, booktabs = TRUE,
             caption = "Kysymyksen V6 vastaukset maittain (%)")
```

**zxy** Tätä ensimmäistä kuvaa on muistiinpanoissa kommentoitu (löytyy printattuna)

```{r simpleCAmap1, fig.cap= "Q1b: lapsi kärsii jos äiti on töissä", fig.asp = 1 }
#simpleCA1 <- ca(~maa + V6,ISSP2012esim1.dat) suoritetaan ennen värikuvaa, tuloksia tarvitaan #siinä.
#symmetrinen kartta

plot(simpleCA1, map = "symmetric", mass = c(TRUE,TRUE),
     main = "Lapsi kärsii jos äiti on töissä -symmetrinen kartta",
     sub = "maa-muuttuja järjestys C_ALPHAN")

plot(simpleCA2, map = "symmetric", mass = c(TRUE,TRUE),
     main = "Lapsi kärsii jos äiti on töissä -symmetrinen kartta ",
     sub = "maa-muuttuja maa2,järjestys as_factor(C_ALPHAN)")


plot(simpleCA3, map = "symmetric", mass = c(TRUE,TRUE),
main = "Lapsi kärsii jos äiti on töissä -symmetrinen kartta ",
sub = "massat kaikilla mailla 1 (riviprofiilidata)")


#str(simpleCA1)
# 13.5.2018 
# kuvasuhteen saa oikeaksi, kun avaa g-ikkunan (X11()) ja sitten plot. Voi tallentaa pdf-muodossa
# grafiikkaikkunasta, ja ladata outputiin knitr-vaiheessa. Parempi tulostaa kuvatdsto pdf-ajurilla, jos lopulliseen versioon joutuu 
# näin tekemään.
# näitä kokeiln chunk-optioissa mutta ei toimineet (out.width = "6", out.hight = "6") 
# (13.5.2018), vaan pdf-konversiossa pandoc failed with error 43

```


Ja toinen tapa - kuvatiedoston lataaminen include_graphics - funktiolla. Pitää 
miettiä mikä on järkevää, dataa tutkaillessa piirretään useita kuvia. PDF-muodossa
ne ovat skaalautuvia, kommentteja voi lisätä jne.

```{r kuvatdsto1, eval=FALSE, include=FALSE}
#tämä toimii
img_path <- "img/1CAmap_sy.pdf"
include_graphics(img_path)
# knitr-funktio, "document format agnostic"
# mutta parametriarvot (out.width = "4", fig.asp = 1 ) tuottavat pandoc error 43, Illegal unit of measure (pt inserted)
#Kuvatiedosto suoraan markdownilla
#![Alt text](img/1CAmap_sy.pdf) - toimii mutta kohdistus väärä, kuva valuu ulos oikealta

```




## Korrespondenssianalyysin käsitteet

1. Profiilit

2. Massat

3. Profiilien etäisyydet (khii2)

**zxy** Ja tätä "triplettiä" täydentää neljä siitä johdettua käsitettä, viite muistiinpanoissa. **#V** Tässäkin CAiP ja  MG2017HY-luentokalvot.





